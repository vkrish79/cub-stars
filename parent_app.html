<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</title>
    
    <!-- PWA Setup -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cub Stars">
    <meta name="theme-color" content="#667eea">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Cub%20Stars%20-%20Parent%22%2C%22short_name%22%3A%22Parent%22%2C%22start_url%22%3A%22.%2Fparent_app.html%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23667eea%22%2C%22theme_color%22%3A%22%23667eea%22%2C%22orientation%22%3A%22portrait%22%7D">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text y='65' x='50' text-anchor='middle' font-size='40'>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #6C5CE7; --success: #00B894; --warning: #FDCB6E; --danger: #E17055; --dark: #2D3436; --light: #DFE6E9; --white: #FFFFFF; }
        html, body { height: 100%; overflow-x: hidden; }
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            min-height: -webkit-fill-available;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            -webkit-tap-highlight-color: transparent;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: var(--white); border-radius: 20px; padding: 25px 30px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
        .header h1 { font-size: 1.8rem; color: var(--dark); }
        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 50px; font-weight: 500; font-size: 0.9rem; background: #D5F4E6; color: var(--success); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border: none; border-radius: 12px; font-family: inherit; font-weight: 600; cursor: pointer; background: rgba(255,255,255,0.3); color: white; transition: all 0.3s ease; }
        .tab-btn:hover { background: rgba(255,255,255,0.5); }
        .tab-btn.active { background: white; color: var(--primary); }
        .notification-badge { background: var(--danger); color: white; padding: 2px 8px; border-radius: 50px; font-size: 0.75rem; margin-left: 5px; }
        .card { background: var(--white); border-radius: 20px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        .card-title { font-size: 1.3rem; color: var(--dark); margin-bottom: 20px; }
        .child-selector { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .child-card { background: white; border-radius: 15px; padding: 20px 30px; cursor: pointer; border: 3px solid transparent; text-align: center; min-width: 150px; transition: all 0.3s ease; }
        .child-card:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .child-card.active { border-color: var(--primary); background: linear-gradient(135deg, #F8F9FF, #EEF0FF); }
        .child-card.boy { border-color: #E74C3C; background: linear-gradient(135deg, #FFEFEF, #FFE5E5); }
        .child-card.girl { border-color: #FF69B4; background: linear-gradient(135deg, #FFF0F5, #FFE4EC); }
        .child-avatar { font-size: 2.5rem; margin-bottom: 10px; }
        .child-name { font-weight: 600; color: var(--dark); }
        .child-stars { color: #F39C12; font-weight: 500; margin-top: 5px; }
        .approval-list { display: grid; gap: 15px; }
        .approval-item { display: flex; align-items: center; gap: 15px; padding: 20px; background: linear-gradient(135deg, #FFF9E6, #FFFBF0); border-radius: 15px; border-left: 5px solid var(--warning); flex-wrap: wrap; }
        .approval-avatar { font-size: 2rem; }
        .approval-info { flex: 1; min-width: 200px; }
        .approval-child { font-weight: 600; color: var(--dark); }
        .approval-task { color: #666; margin-top: 3px; }
        .approval-stars { color: #F39C12; font-weight: 600; }
        .approval-time { font-size: 0.8rem; color: #999; margin-top: 5px; }
        .approval-actions { display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: inherit; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .quick-bonus-btn { background: linear-gradient(135deg, #F39C12, #E67E22); color: white; padding: 12px 18px; font-size: 1rem; }
        .quick-bonus-btn:active { transform: scale(0.95); }
        .bonus-special { background: linear-gradient(135deg, #9B59B6, #8E44AD); }
        .task-template-btn { background: #f0f4ff; border: 2px solid #667eea; color: #667eea; padding: 8px 12px; font-size: 0.85rem; border-radius: 20px; margin: 3px; }
        .task-template-btn:hover { background: #667eea; color: white; }
        .recurring-toggle { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .toggle-switch { position: relative; width: 50px; height: 26px; background: #ccc; border-radius: 13px; cursor: pointer; transition: 0.3s; }
        .toggle-switch.active { background: #4CAF50; }
        .toggle-switch::after { content: ''; position: absolute; width: 22px; height: 22px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .toggle-switch.active::after { left: 26px; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-small { padding: 8px 15px; font-size: 0.85rem; }
        .item-grid { display: grid; gap: 15px; }
        .item-row { display: flex; align-items: center; gap: 15px; padding: 15px 20px; background: #F8F9FA; border-radius: 12px; flex-wrap: wrap; }
        .item-icon { font-size: 1.5rem; }
        .item-info { flex: 1; min-width: 150px; }
        .item-name { font-weight: 600; color: var(--dark); }
        .item-meta { font-size: 0.85rem; color: #888; margin-top: 2px; }
        .item-value { font-weight: 700; color: #F39C12; }
        .delete-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.4; }
        .delete-btn:hover { opacity: 1; }
        .form-section { background: #F8F9FA; border-radius: 15px; padding: 20px; margin-top: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 500; color: var(--dark); font-size: 0.9rem; }
        .form-group input, .form-group select { padding: 12px 15px; border: 2px solid var(--light); border-radius: 10px; font-family: inherit; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary); }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .empty-state .emoji { font-size: 4rem; margin-bottom: 15px; }
        /* Coupon Styles */
        /* Colorful Coupon Cards - inspired by kid coupon design */
        .coupon-card {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        .coupon-card-top {
            padding: 15px 20px;
            text-align: center;
            position: relative;
        }
        .coupon-card-top::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            right: 10%;
            height: 3px;
            background: repeating-linear-gradient(90deg, currentColor 0, currentColor 8px, transparent 8px, transparent 12px);
            opacity: 0.3;
        }
        .coupon-header {
            font-family: 'Georgia', serif;
            font-style: italic;
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 8px;
        }
        .coupon-reward {
            font-size: 1.4rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #1a1a1a;
            line-height: 1.2;
        }
        .coupon-subtitle {
            font-size: 0.85rem;
            font-weight: 600;
            color: #444;
            margin-top: 4px;
        }
        .coupon-card-bottom {
            background: #f8f8f8;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px dashed #ddd;
        }
        .coupon-child-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .coupon-child-avatar {
            font-size: 1.5rem;
        }
        .coupon-child-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        .coupon-date {
            font-size: 0.75rem;
            color: #888;
        }
        .redeem-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #27AE60, #2ECC71);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(39,174,96,0.3);
            transition: transform 0.2s;
        }
        .redeem-btn:active { transform: scale(0.95); }
        /* Coupon color themes */
        .coupon-teal .coupon-card-top { background: linear-gradient(135deg, #26a69a, #4db6ac); color: white; }
        .coupon-teal .coupon-header, .coupon-teal .coupon-reward, .coupon-teal .coupon-subtitle { color: white; }
        .coupon-pink .coupon-card-top { background: linear-gradient(135deg, #ec407a, #f48fb1); color: white; }
        .coupon-pink .coupon-header, .coupon-pink .coupon-reward, .coupon-pink .coupon-subtitle { color: white; }
        .coupon-blue .coupon-card-top { background: linear-gradient(135deg, #42a5f5, #64b5f6); color: white; }
        .coupon-blue .coupon-header, .coupon-blue .coupon-reward, .coupon-blue .coupon-subtitle { color: white; }
        .coupon-yellow .coupon-card-top { background: linear-gradient(135deg, #ffca28, #ffd54f); }
        .coupon-yellow .coupon-header, .coupon-yellow .coupon-subtitle { color: #5d4037; }
        .coupon-yellow .coupon-reward { color: #3e2723; }
        .coupon-green .coupon-card-top { background: linear-gradient(135deg, #66bb6a, #81c784); color: white; }
        .coupon-green .coupon-header, .coupon-green .coupon-reward, .coupon-green .coupon-subtitle { color: white; }
        .coupon-purple .coupon-card-top { background: linear-gradient(135deg, #ab47bc, #ce93d8); color: white; }
        .coupon-purple .coupon-header, .coupon-purple .coupon-reward, .coupon-purple .coupon-subtitle { color: white; }
        .coupon-stripes {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: repeating-linear-gradient(0deg, rgba(255,255,255,0.3) 0px, rgba(255,255,255,0.3) 4px, transparent 4px, transparent 8px);
        }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .refresh-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .refresh-btn.loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--dark); color: white; padding: 15px 30px; border-radius: 50px; font-weight: 500; opacity: 0; transition: all 0.3s ease; z-index: 1000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .stars-control { display: flex; gap: 10px; align-items: center; margin-top: 15px; padding: 15px; background: #E8F5E9; border-radius: 10px; flex-wrap: wrap; }
        .stars-control input { width: 80px; padding: 8px; border: 2px solid #81C784; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h1>
                <div class="status-badge">‚úì Connected</div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('approvals', this)">‚úÖ Approvals <span class="notification-badge" id="approvalCount">0</span></button>
            <button class="tab-btn" onclick="switchTab('manage', this)">üìã Manage Tasks</button>
            <button class="tab-btn" onclick="switchTab('rewards', this)">üéÅ Manage Rewards</button>
            <button class="tab-btn" onclick="switchTab('stars', this)">‚≠ê Manage Coins</button>
            <button class="tab-btn" onclick="switchTab('settings', this)">‚öôÔ∏è Reset</button>
            <button class="refresh-btn" onclick="loadData()" title="Refresh">üîÑ</button>
        </div>
        <div class="child-selector" id="childSelector"></div>
        <div class="tab-panel active" id="approvalsPanel">
            <!-- COUPONS SECTION - FIRST FOR VISIBILITY -->
            <div class="card" style="border: 3px solid #FFD700; background: linear-gradient(135deg, #FFFBF0 0%, #FFF9E6 100%);">
                <h2 class="card-title" style="color: #B8860B; font-size: 1.2rem;">üéüÔ∏è Coupons to Redeem <span class="notification-badge" id="couponCount" style="background:#FFD700;color:#333;">0</span></h2>
                <div id="couponList"><div class="empty-state"><div class="emoji">üéüÔ∏è</div><p>No coupons waiting!</p></div></div>
            </div>
            
            <div class="card">
                <h2 class="card-title">üìã Pending Task Approvals</h2>
                <div class="approval-list" id="approvalList"><div class="empty-state"><div class="emoji">‚ú®</div><p>No pending task approvals!</p></div></div>
            </div>
            <div class="card">
                <h2 class="card-title">üéÅ Pending Reward Claims</h2>
                <div class="approval-list" id="rewardClaimList"><div class="empty-state"><div class="emoji">üéÅ</div><p>No pending reward claims!</p></div></div>
            </div>
        </div>
        <div class="tab-panel" id="managePanel">
            <div class="card">
                <h2 class="card-title">üìã Tasks for <span id="taskChildName">Select Child</span></h2>
                
                <!-- Task Templates -->
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 12px;">
                    <h4 style="margin-bottom: 10px;">üìù Quick Templates</h4>
                    <div style="display: flex; flex-wrap: wrap;">
                        <button class="task-template-btn" onclick="useTemplate('Make the bed', 2, 'üè†')">üõèÔ∏è Make bed</button>
                        <button class="task-template-btn" onclick="useTemplate('Brush teeth', 2, 'üí™')">ü¶∑ Brush teeth</button>
                        <button class="task-template-btn" onclick="useTemplate('Clean room', 5, 'üè†')">üßπ Clean room</button>
                        <button class="task-template-btn" onclick="useTemplate('Do homework', 5, 'üìö')">üìñ Homework</button>
                        <button class="task-template-btn" onclick="useTemplate('Read for 20 mins', 3, 'üìö')">üìö Reading</button>
                        <button class="task-template-btn" onclick="useTemplate('Help with dishes', 3, 'üè†')">üçΩÔ∏è Dishes</button>
                        <button class="task-template-btn" onclick="useTemplate('Exercise/Play outside', 3, 'üí™')">üèÉ Exercise</button>
                        <button class="task-template-btn" onclick="useTemplate('Practice instrument', 5, 'üé®')">üéµ Practice</button>
                        <button class="task-template-btn" onclick="useTemplate('Be kind to sibling', 3, 'ü§ù')">üíï Kindness</button>
                        <button class="task-template-btn" onclick="useTemplate('No screen time today', 10, 'üí™')">üìµ No screens</button>
                    </div>
                </div>
                
                <div class="form-section">
                    <h4 style="margin-bottom: 15px;">‚ûï Add New Task</h4>
                    <div class="form-grid">
                        <div class="form-group"><label>Task Name</label><input type="text" id="newTaskName" placeholder="e.g., Make the bed"></div>
                        <div class="form-group"><label>Coins ü™ô</label><select id="newTaskStars"><option value="1">1 Coin</option><option value="2">2 Coins</option><option value="3" selected>3 Coins</option><option value="5">5 Coins</option><option value="10">10 Coins</option></select></div>
                        <div class="form-group"><label>Category</label><select id="newTaskCategory"><option value="üè†">üè† Home</option><option value="üìö">üìö Learning</option><option value="üí™">üí™ Health</option><option value="ü§ù">ü§ù Kindness</option><option value="üé®">üé® Creative</option></select></div>
                    </div>
                    <!-- Recurring Task Option -->
                    <div class="recurring-toggle">
                        <div id="recurringToggle" class="toggle-switch" onclick="toggleRecurring()"></div>
                        <span>üîÑ Recurring Task (resets daily)</span>
                        <input type="hidden" id="isRecurring" value="false">
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="addTask()">Add Task</button>
                    </div>
                </div>
                <div class="item-grid" id="taskList" style="margin-top: 20px;"></div>
            </div>
        </div>
        <div class="tab-panel" id="rewardsPanel">
            <div class="card">
                <h2 class="card-title">üéÅ Rewards for <span id="rewardChildName">Select Child</span></h2>
                <div class="form-section">
                    <h4 style="margin-bottom: 15px;">‚ûï Add New Reward</h4>
                    <div class="form-grid">
                        <div class="form-group"><label>Reward Name</label><input type="text" id="newRewardName" placeholder="e.g., Ice cream treat"></div>
                        <div class="form-group"><label>Cost ‚≠ê</label><select id="newRewardCost"><option value="10">10 Stars</option><option value="20">20 Stars</option><option value="30" selected>30 Stars</option><option value="50">50 Stars</option><option value="100">100 Stars</option></select></div>
                        <div class="form-group"><label>Icon</label><select id="newRewardIcon"><option value="üç¶">üç¶ Ice Cream</option><option value="üéÆ">üéÆ Game Time</option><option value="üì∫">üì∫ TV Time</option><option value="üé¨">üé¨ Movie</option><option value="üõçÔ∏è">üõçÔ∏è Shopping</option><option value="üé¢">üé¢ Adventure</option><option value="üß∏">üß∏ Toy</option><option value="üì±">üì± Screen Time</option></select></div>
                        <div class="form-group" style="justify-content: flex-end;"><button class="btn btn-primary" onclick="addReward()">Add Reward</button></div>
                    </div>
                </div>
                <div class="item-grid" id="rewardList" style="margin-top: 20px;"></div>
            </div>
        </div>
        <div class="tab-panel" id="starsPanel">
            <div class="card">
                <h2 class="card-title">ü™ô Manage Coins for <span id="starsChildName">Select Child</span></h2>
                <p style="color: #666; margin-bottom: 15px;">Add bonus coins or remove coins as needed.</p>
                
                <!-- Quick Bonus Coins -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">‚ö° Quick Bonus Coins</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn quick-bonus-btn" onclick="quickBonus(1)">+1 ü™ô</button>
                        <button class="btn quick-bonus-btn" onclick="quickBonus(3)">+3 ü™ô</button>
                        <button class="btn quick-bonus-btn" onclick="quickBonus(5)">+5 ü™ô</button>
                        <button class="btn quick-bonus-btn" onclick="quickBonus(10)">+10 ü™ô</button>
                        <button class="btn quick-bonus-btn bonus-special" onclick="quickBonus(25)">+25 üåü</button>
                    </div>
                </div>
                
                <div class="stars-control">
                    <span style="font-weight: 500;">Custom:</span>
                    <input type="number" id="starsAmount" value="5" min="1" max="100">
                    <button class="btn btn-success" onclick="addStars()">‚ûï Add</button>
                    <button class="btn btn-danger" onclick="removeStars()">‚ûñ Remove</button>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                    <h4 style="margin-bottom: 15px;">üíå Send Encouragement</h4>
                    <button class="btn" style="background: linear-gradient(135deg, #9B59B6, #8E44AD); color: white;" onclick="sendMessage()">üíå Send Message to Child</button>
                </div>
                <div id="starsHistory" style="margin-top: 20px;"></div>
            </div>
        </div>
        <div class="tab-panel" id="settingsPanel">
            <!-- Test Coupon Card - For debugging -->
            <div class="card" style="border: 2px dashed #FFD700; background: #FFFBF0;">
                <h2 class="card-title" style="color: #B8860B;">üß™ Test Coupons</h2>
                <p style="color: #666; margin-bottom: 15px;">Add test coupons to verify the display is working.</p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="addTestCoupon()">‚ûï Add Test Coupon</button>
                    <button class="btn btn-danger" onclick="clearTestCoupons()">üóëÔ∏è Clear All Coupons</button>
                </div>
            </div>
            
            <!-- Push Notifications Card -->
            <div class="card">
                <h2 class="card-title">üîî Push Notifications</h2>
                <p style="color: #666; margin-bottom: 15px;">Get notified when your kids complete tasks!</p>
                
                <div id="notificationStatus" style="padding: 15px; border-radius: 10px; margin-bottom: 15px; background: #f5f5f5;">
                    <span id="notifStatusText">Checking notification support...</span>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button id="enableNotifBtn" class="btn btn-primary" onclick="enableNotifications()" style="display:none;">
                        üîî Enable Notifications
                    </button>
                    <button id="testNotifBtn" class="btn" onclick="testNotification()" style="display:none; background: #9C27B0; color: white;">
                        üì≤ Send Test
                    </button>
                    <button id="disableNotifBtn" class="btn btn-danger" onclick="disableNotifications()" style="display:none;">
                        üîï Disable
                    </button>
                </div>
                
                <div id="notifFrequency" style="margin-top: 15px; display: none;">
                    <label style="font-weight: 500;">Check for updates every:</label>
                    <select id="pollInterval" onchange="updatePollInterval()" style="padding: 8px; border-radius: 8px; margin-left: 10px;">
                        <option value="30000">30 seconds</option>
                        <option value="60000" selected>1 minute</option>
                        <option value="300000">5 minutes</option>
                        <option value="600000">10 minutes</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title">‚öôÔ∏è Reset Progress for <span id="settingsChildName">Select Child</span></h2>
                <p style="color: #666; margin-bottom: 20px;">Reset specific progress items for the selected child. This cannot be undone!</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="background: #FFF3CD; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>üî• Reset Streak</strong>
                            <div style="font-size: 0.85rem; color: #666;">Sets current streak and longest streak to 0</div>
                        </div>
                        <button class="btn btn-danger" onclick="resetProgress('streak')">Reset Streak</button>
                    </div>
                    
                    <div style="background: #F0F4FF; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>üèÜ Reset Badges</strong>
                            <div style="font-size: 0.85rem; color: #666;">Removes all earned badges</div>
                        </div>
                        <button class="btn btn-danger" onclick="resetProgress('badges')">Reset Badges</button>
                    </div>
                    
                    <div style="background: #FFF8E1; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>ü™ô Reset Coins</strong>
                            <div style="font-size: 0.85rem; color: #666;">Sets coin balance to 0</div>
                        </div>
                        <button class="btn btn-danger" onclick="resetProgress('coins')">Reset Coins</button>
                    </div>
                    
                    <div style="background: #FFEBEE; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #E53935;">
                        <div>
                            <strong>‚ö†Ô∏è Reset Everything</strong>
                            <div style="font-size: 0.85rem; color: #666;">Resets streak, badges, coins, tasks, and messages</div>
                        </div>
                        <button class="btn" style="background: #C62828; color: white;" onclick="resetProgress('all')">Reset All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="toast" id="toast"></div>
    <script>
        // ‚ö†Ô∏è CONFIGURATION - Set your Google Apps Script URL here:
        var API_URL = 'https://script.google.com/macros/s/AKfycbx_vl_qhbYnbH5TcYOGMepizK1lpidTFKx22oUV28GxFXqvt7xCAH1o6xbKR3HvJriH/exec';
        // Example: var API_URL = 'https://script.google.com/macros/s/ABC123.../exec';
        
        var CACHE_KEY = 'cubstars_parent_cache';
        var data = { children: [] };
        var selectedChildId = null;
        var isLoading = false;
        var lastFetch = 0;

        // Show loading indicator
        function showLoading(show) {
            var btn = document.querySelector('.refresh-btn');
            if (btn) btn.classList.toggle('loading', show);
        }

        // Cache management
        function saveToCache(data) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    data: data,
                    timestamp: Date.now()
                }));
            } catch(e) {}
        }

        function loadFromCache() {
            try {
                var cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    var parsed = JSON.parse(cached);
                    if (Date.now() - parsed.timestamp < 300000) {
                        return parsed.data;
                    }
                }
            } catch(e) {}
            return null;
        }

        // Optimized API call with timeout
        function apiCall(action, params) {
            params = params || {};
            return new Promise(function(resolve, reject) {
                var url = new URL(API_URL);
                url.searchParams.append('action', action);
                for (var key in params) {
                    var value = params[key];
                    url.searchParams.append(key, typeof value === 'object' ? JSON.stringify(value) : value);
                }
                
                var timeout = setTimeout(function() {
                    reject(new Error('Timeout'));
                }, 15000);
                
                fetch(url.toString())
                    .then(function(r) { 
                        clearTimeout(timeout);
                        return r.json(); 
                    })
                    .then(resolve)
                    .catch(function(e) {
                        clearTimeout(timeout);
                        reject(e);
                    });
            });
        }

        function loadData(forceRefresh) {
            if (isLoading) return;
            
            if (!forceRefresh && Date.now() - lastFetch < 5000) return;
            
            // Show cached data immediately
            if (!forceRefresh && data.children.length === 0) {
                var cached = loadFromCache();
                if (cached) {
                    data = cached;
                    renderAll();
                }
            }
            
            isLoading = true;
            showLoading(true);
            lastFetch = Date.now();
            
            apiCall('getData').then(function(result) {
                data = result;
                saveToCache(result);
                renderAll();
                showToast('Data loaded!', 'success');
            }).catch(function(error) {
                showToast('Error loading data', 'error');
            }).finally(function() {
                isLoading = false;
                showLoading(false);
            });
        }

        // Refresh when app becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) loadData();
        });

        function renderAll() {
            renderChildSelector();
            renderApprovals();
            renderCoupons();
            renderTasks();
            renderRewards();
            renderStars();
        }

        function renderChildSelector() {
            var container = document.getElementById('childSelector');
            if (!selectedChildId && data.children.length > 0) selectedChildId = data.children[0].id;
            var html = '';
            data.children.forEach(function(child) {
                var isActive = child.id === selectedChildId ? 'active' : '';
                var streakHtml = child.streak > 0 ? '<div style="font-size:0.8rem;color:#FF6B35;">üî• ' + child.streak + ' day streak</div>' : '';
                var badgeCount = (child.badges || []).length;
                var badgeHtml = badgeCount > 0 ? '<div style="font-size:0.75rem;color:#888;">üèÜ ' + badgeCount + ' badges</div>' : '';
                html += '<div class="child-card ' + child.type + ' ' + isActive + '" onclick="selectChild(\'' + child.id + '\')">' +
                    '<div class="child-avatar">' + child.avatar + '</div>' +
                    '<div class="child-name">' + child.name + '</div>' +
                    '<div class="child-stars">ü™ô ' + child.stars + ' Coins</div>' +
                    streakHtml + badgeHtml + '</div>';
            });
            container.innerHTML = html;
        }

        function selectChild(childId) {
            selectedChildId = childId;
            renderAll();
        }

        function renderApprovals() {
            var container = document.getElementById('approvalList');
            var rewardContainer = document.getElementById('rewardClaimList');
            var allApprovals = [];
            var allRewardClaims = [];
            
            data.children.forEach(function(child) {
                if (child.pendingApprovals) {
                    child.pendingApprovals.forEach(function(a) {
                        allApprovals.push({id: a.id, taskName: a.taskName, stars: a.stars, submittedAt: a.submittedAt, photo: a.photo, childId: child.id, childName: child.name, childAvatar: child.avatar});
                    });
                }
                if (child.pendingRewardClaims) {
                    child.pendingRewardClaims.forEach(function(c) {
                        allRewardClaims.push({id: c.id, rewardName: c.rewardName, rewardIcon: c.rewardIcon, cost: c.cost, submittedAt: c.submittedAt, childId: child.id, childName: child.name, childAvatar: child.avatar, childStars: child.stars});
                    });
                }
            });
            
            document.getElementById('approvalCount').textContent = allApprovals.length + allRewardClaims.length;
            
            if (allApprovals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="emoji">‚ú®</div><p>No pending tasks!</p></div>';
            } else {
                var html = '';
                allApprovals.forEach(function(a) {
                    var photoHtml = a.photo ? '<div style="margin:10px 0;"><img src="' + a.photo + '" style="max-width:150px;max-height:100px;border-radius:10px;cursor:pointer;" onclick="viewPhoto(this.src)"></div>' : '';
                    html += '<div class="approval-item">' +
                        '<div class="approval-avatar">' + a.childAvatar + '</div>' +
                        '<div class="approval-info">' +
                        '<div class="approval-child">' + a.childName + '</div>' +
                        '<div class="approval-task">Completed: ' + a.taskName + '</div>' +
                        '<div class="approval-stars">‚≠ê +' + a.stars + ' stars</div>' +
                        photoHtml +
                        '<div class="approval-time">' + formatTime(a.submittedAt) + '</div>' +
                        '<input type="text" id="msg_' + a.id + '" placeholder="üíå Add encouragement message (optional)" style="width:100%;padding:8px 12px;border:2px solid #ddd;border-radius:10px;margin-top:8px;font-size:0.9rem;">' +
                        '</div>' +
                        '<div class="approval-actions">' +
                        '<button class="btn btn-success btn-small" onclick="approveTask(\'' + a.childId + '\',' + a.id + ')">‚úì Approve</button>' +
                        '<button class="btn btn-danger btn-small" onclick="rejectTask(\'' + a.childId + '\',' + a.id + ')">‚úó Reject</button></div></div>';
                });
                container.innerHTML = html;
            }
            
            if (allRewardClaims.length === 0) {
                rewardContainer.innerHTML = '<div class="empty-state"><div class="emoji">üéÅ</div><p>No pending claims!</p></div>';
            } else {
                var html = '';
                allRewardClaims.forEach(function(c) {
                    html += '<div class="approval-item" style="border-left-color:#9B59B6;background:linear-gradient(135deg,#F5EEF8,#FDFBFE);">' +
                        '<div class="approval-avatar">' + c.rewardIcon + '</div>' +
                        '<div class="approval-info">' +
                        '<div class="approval-child">' + c.childName + ' ' + c.childAvatar + '</div>' +
                        '<div class="approval-task">Wants: <strong>' + c.rewardName + '</strong></div>' +
                        '<div class="approval-stars" style="color:#E67E22;">‚≠ê -' + c.cost + ' stars (has ' + c.childStars + ')</div>' +
                        '<div class="approval-time">' + formatTime(c.submittedAt) + '</div></div>' +
                        '<div class="approval-actions">' +
                        '<button class="btn btn-success btn-small" onclick="approveRewardClaim(\'' + c.childId + '\',' + c.id + ')">‚úì Allow</button>' +
                        '<button class="btn btn-danger btn-small" onclick="rejectRewardClaim(\'' + c.childId + '\',' + c.id + ')">‚úó Deny</button></div></div>';
                });
                rewardContainer.innerHTML = html;
            }
        }
        
        function viewPhoto(src) {
            var overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
            overlay.innerHTML = '<img src="' + src + '" style="max-width:90%;max-height:90%;border-radius:15px;"><button style="position:absolute;top:20px;right:20px;background:white;border:none;border-radius:50%;width:50px;height:50px;font-size:1.5rem;cursor:pointer;">‚úï</button>';
            overlay.onclick = function() { overlay.remove(); };
            document.body.appendChild(overlay);
        }

        function renderCoupons() {
            var couponList = document.getElementById('couponList');
            var couponCount = document.getElementById('couponCount');
            
            // Collect all coupons from children data (loaded from API)
            var pendingCoupons = [];
            if (data && data.children) {
                data.children.forEach(function(child) {
                    if (child.sentCoupons && child.sentCoupons.length > 0) {
                        child.sentCoupons.forEach(function(coupon) {
                            coupon.childName = child.name;
                            coupon.childId = child.id;
                            pendingCoupons.push(coupon);
                        });
                    }
                });
            }
            
            // Color themes that rotate
            var colorThemes = ['coupon-teal', 'coupon-pink', 'coupon-blue', 'coupon-yellow', 'coupon-green', 'coupon-purple'];
            
            couponCount.textContent = pendingCoupons.length;
            couponCount.style.display = pendingCoupons.length > 0 ? 'inline-block' : 'none';
            
            if (pendingCoupons.length === 0) {
                couponList.innerHTML = '<div class="empty-state"><div class="emoji">üéüÔ∏è</div><p>No coupons waiting!</p></div>';
                return;
            }
            
            var html = '';
            pendingCoupons.forEach(function(coupon, index) {
                var sentDate = coupon.sentAt ? new Date(coupon.sentAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'Today';
                var colorClass = colorThemes[index % colorThemes.length];
                
                html += '<div class="coupon-card ' + colorClass + '">';
                html += '<div class="coupon-card-top">';
                html += '<div class="coupon-stripes"></div>';
                html += '<div class="coupon-header">this coupon is good for</div>';
                html += '<div class="coupon-reward">' + (coupon.rewardIcon || 'üéÅ') + ' ' + coupon.rewardName + '</div>';
                html += '<div class="coupon-subtitle">REDEEM ANYTIME!</div>';
                html += '</div>';
                html += '<div class="coupon-card-bottom">';
                html += '<div class="coupon-child-info">';
                html += '<span class="coupon-child-avatar">‚≠ê</span>';
                html += '<div><div class="coupon-child-name">' + coupon.childName + '</div>';
                html += '<div class="coupon-date">' + sentDate + '</div></div>';
                html += '</div>';
                html += '<button class="redeem-btn" onclick="redeemCoupon(\'' + coupon.id + '\', \'' + coupon.childId + '\')">‚úÖ Redeem</button>';
                html += '</div>';
                html += '</div>';
            });
            couponList.innerHTML = html;
        }
        
        function redeemCoupon(couponId, childId) {
            apiCall('redeemCoupon', { coupon: { couponId: couponId, childId: childId } })
                .then(function() {
                    showToast('‚úÖ Coupon redeemed!', 'success');
                    loadData(true);
                })
                .catch(function(err) {
                    showToast('Error: ' + err.message, 'error');
                });
        }
        
        // Test function - adds a test coupon via API
        function addTestCoupon() {
            var testChildId = selectedChildId || (data.children && data.children[0] ? data.children[0].id : 'boy1');
            apiCall('sendCoupon', { 
                coupon: {
                    id: 'TEST-' + Date.now(),
                    rewardName: 'Movie Night',
                    rewardIcon: 'üé¨',
                    childId: testChildId
                }
            }).then(function() {
                showToast('Test coupon added!', 'success');
                loadData(true);
            }).catch(function(err) {
                showToast('Error: ' + err.message, 'error');
            });
        }
        
        // Clear all coupons for selected child
        function clearTestCoupons() {
            if (data && data.children) {
                var promises = [];
                data.children.forEach(function(child) {
                    if (child.sentCoupons) {
                        child.sentCoupons.forEach(function(coupon) {
                            promises.push(apiCall('redeemCoupon', { coupon: { couponId: coupon.id, childId: child.id } }));
                        });
                    }
                });
                Promise.all(promises).then(function() {
                    showToast('All coupons cleared!', 'success');
                    loadData(true);
                });
            }
        }
        
        function renderTasks() {
            var child = data.children.find(function(c) { return c.id === selectedChildId; });
            document.getElementById('taskChildName').textContent = child ? child.name : 'Select Child';
            var container = document.getElementById('taskList');
            if (!child || !child.tasks || child.tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="emoji">üìã</div><p>No tasks yet.</p></div>';
                return;
            }
            var html = '';
            child.tasks.forEach(function(t) {
                var recurringBadge = t.recurring ? '<span style="background:#E8F5E9;color:#4CAF50;padding:2px 8px;border-radius:10px;font-size:0.75rem;margin-left:5px;">üîÑ Daily</span>' : '';
                html += '<div class="item-row">' +
                    '<div class="item-icon">' + t.category + '</div>' +
                    '<div class="item-info"><div class="item-name">' + t.name + recurringBadge + '</div>' +
                    '<div class="item-meta">' + (t.completed ? '‚úÖ Completed' : '‚è≥ Pending') + '</div></div>' +
                    '<div class="item-value">ü™ô ' + t.stars + '</div>' +
                    (t.completed ? '<button class="btn btn-small" style="background:#FFC107;color:#333;" onclick="resetTask(' + t.id + ')">üîÑ Reset</button>' : '') +
                    '<button class="delete-btn" onclick="deleteTask(' + t.id + ')">üóëÔ∏è</button></div>';
            });
            container.innerHTML = html;
        }

        function renderRewards() {
            var child = data.children.find(function(c) { return c.id === selectedChildId; });
            document.getElementById('rewardChildName').textContent = child ? child.name : 'Select Child';
            var container = document.getElementById('rewardList');
            if (!child || !child.rewards || child.rewards.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="emoji">üéÅ</div><p>No rewards yet.</p></div>';
                return;
            }
            var html = '';
            child.rewards.forEach(function(r) {
                html += '<div class="item-row">' +
                    '<div class="item-icon">' + r.icon + '</div>' +
                    '<div class="item-info"><div class="item-name">' + r.name + '</div></div>' +
                    '<div class="item-value">‚≠ê ' + r.cost + '</div>' +
                    '<button class="delete-btn" onclick="deleteReward(' + r.id + ')">üóëÔ∏è</button></div>';
            });
            container.innerHTML = html;
        }

        function renderStars() {
            var child = data.children.find(function(c) { return c.id === selectedChildId; });
            document.getElementById('starsChildName').textContent = child ? child.name + ' (Current: ' + child.stars + ' ü™ô)' : 'Select Child';
            document.getElementById('settingsChildName').textContent = child ? child.name : 'Select Child';
            var container = document.getElementById('starsHistory');
            if (!child || !child.history || child.history.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="emoji">üìú</div><p>No history yet.</p></div>';
                return;
            }
            var html = '<h4 style="margin-bottom:10px;">Recent History</h4>';
            child.history.slice(-10).reverse().forEach(function(h) {
                var bg = h.type === 'earned' ? '#E8F5E9' : '#FFF3E0';
                var color = h.type === 'earned' ? '#4CAF50' : '#FF9800';
                var sign = h.type === 'earned' ? '+' : '-';
                html += '<div style="padding:10px;background:' + bg + ';border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;">' +
                    '<span>' + h.action + '</span><span style="color:' + color + ';font-weight:600;">' + sign + h.stars + ' ü™ô</span></div>';
            });
            container.innerHTML = html;
        }

        function approveTask(childId, approvalId) {
            var msgInput = document.getElementById('msg_' + approvalId);
            var message = msgInput ? msgInput.value.trim() : '';
            apiCall('approveTask', { approve: { childId: childId, approvalId: approvalId, message: message } }).then(function() {
                showToast('Task approved! ‚≠ê' + (message ? ' üíå' : ''), 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function rejectTask(childId, approvalId) {
            apiCall('rejectTask', { reject: { childId: childId, approvalId: approvalId } }).then(function() {
                showToast('Task rejected', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function approveRewardClaim(childId, claimId) {
            apiCall('approveRewardClaim', { approve: { childId: childId, claimId: claimId } }).then(function() {
                showToast('Reward approved! üéÅ', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function rejectRewardClaim(childId, claimId) {
            apiCall('rejectRewardClaim', { reject: { childId: childId, claimId: claimId } }).then(function() {
                showToast('Reward denied', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }
        
        function sendMessage() {
            if (!selectedChildId) { showToast('Select a child first', 'error'); return; }
            var text = prompt('üíå Enter a message for your child:');
            if (!text || !text.trim()) return;
            apiCall('sendMessage', { message: { childId: selectedChildId, text: text.trim() } }).then(function() {
                showToast('Message sent! üíå', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function addTask() {
            var name = document.getElementById('newTaskName').value.trim();
            if (!name || !selectedChildId) { showToast('Enter task name and select child', 'error'); return; }
            var isRecurring = document.getElementById('isRecurring').value === 'true';
            apiCall('addTask', { task: { childId: selectedChildId, name: name, stars: parseInt(document.getElementById('newTaskStars').value), category: document.getElementById('newTaskCategory').value, recurring: isRecurring } }).then(function() {
                document.getElementById('newTaskName').value = '';
                document.getElementById('isRecurring').value = 'false';
                document.getElementById('recurringToggle').classList.remove('active');
                showToast('Task added! üìã' + (isRecurring ? ' (Recurring)' : ''), 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }
        
        function quickBonus(amount) {
            if (!selectedChildId) { showToast('Select a child first', 'error'); return; }
            apiCall('addStars', { stars: { childId: selectedChildId, amount: amount } }).then(function() {
                showToast('Bonus! +' + amount + ' coins! üéâ', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }
        
        function useTemplate(name, stars, category) {
            document.getElementById('newTaskName').value = name;
            document.getElementById('newTaskStars').value = stars;
            document.getElementById('newTaskCategory').value = category;
            showToast('Template loaded! Edit or click Add Task', 'success');
        }
        
        function toggleRecurring() {
            var toggle = document.getElementById('recurringToggle');
            var input = document.getElementById('isRecurring');
            if (input.value === 'true') {
                input.value = 'false';
                toggle.classList.remove('active');
            } else {
                input.value = 'true';
                toggle.classList.add('active');
            }
        }

        function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;
            apiCall('deleteTask', { task: { childId: selectedChildId, taskId: taskId } }).then(function() {
                showToast('Task deleted', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function resetTask(taskId) {
            apiCall('resetTask', { task: { childId: selectedChildId, taskId: taskId } }).then(function() {
                showToast('Task reset!', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function addReward() {
            var name = document.getElementById('newRewardName').value.trim();
            if (!name || !selectedChildId) { showToast('Enter reward name and select child', 'error'); return; }
            apiCall('addReward', { reward: { childId: selectedChildId, name: name, cost: parseInt(document.getElementById('newRewardCost').value), icon: document.getElementById('newRewardIcon').value } }).then(function() {
                document.getElementById('newRewardName').value = '';
                showToast('Reward added! üéÅ', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function deleteReward(rewardId) {
            if (!confirm('Delete this reward?')) return;
            apiCall('deleteReward', { reward: { childId: selectedChildId, rewardId: rewardId } }).then(function() {
                showToast('Reward deleted', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function addStars() {
            var amount = parseInt(document.getElementById('starsAmount').value);
            if (!amount || !selectedChildId) return;
            apiCall('addStars', { stars: { childId: selectedChildId, amount: amount } }).then(function() {
                showToast('Added ' + amount + ' coins! ü™ô', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function removeStars() {
            var amount = parseInt(document.getElementById('starsAmount').value);
            if (!amount || !selectedChildId) return;
            apiCall('removeStars', { stars: { childId: selectedChildId, amount: amount } }).then(function() {
                showToast('Removed ' + amount + ' coins', 'success');
                loadData();
            }).catch(function() { showToast('Error', 'error'); });
        }

        function resetProgress(type) {
            if (!selectedChildId) {
                showToast('Please select a child first', 'error');
                return;
            }
            
            var messages = {
                streak: 'Reset streak to 0?',
                badges: 'Remove all badges?',
                coins: 'Reset coins to 0?',
                all: '‚ö†Ô∏è Reset ALL progress? This includes streak, badges, coins, tasks, and messages!'
            };
            
            if (!confirm(messages[type])) return;
            
            apiCall('resetProgress', { reset: { childId: selectedChildId, type: type } }).then(function() {
                var successMessages = {
                    streak: 'üî• Streak reset to 0',
                    badges: 'üèÜ All badges removed',
                    coins: 'ü™ô Coins reset to 0',
                    all: '‚ö†Ô∏è All progress reset'
                };
                showToast(successMessages[type], 'success');
                loadData();
            }).catch(function() { showToast('Error resetting', 'error'); });
        }

        function switchTab(tabName, btn) {
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById(tabName + 'Panel').classList.add('active');
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            var diff = Date.now() - new Date(dateString).getTime();
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + ' min ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + ' hours ago';
            return new Date(dateString).toLocaleDateString();
        }

        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        loadData();
        initNotifications();
        
        // ========== PUSH NOTIFICATIONS ==========
        var swRegistration = null;
        var notifPollInterval = null;
        var lastPendingCount = 0;
        
        function initNotifications() {
            var statusEl = document.getElementById('notifStatusText');
            var statusBox = document.getElementById('notificationStatus');
            var enableBtn = document.getElementById('enableNotifBtn');
            var testBtn = document.getElementById('testNotifBtn');
            var disableBtn = document.getElementById('disableNotifBtn');
            var freqDiv = document.getElementById('notifFrequency');
            
            // Check if notifications are supported
            if (!('Notification' in window)) {
                statusEl.textContent = '‚ùå Notifications not supported in this browser';
                statusBox.style.background = '#FFEBEE';
                return;
            }
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./parent_sw.js')
                    .then(function(reg) {
                        swRegistration = reg;
                        console.log('Service Worker registered');
                        updateNotificationUI();
                    })
                    .catch(function(err) {
                        console.error('Service Worker registration failed:', err);
                        statusEl.textContent = '‚ö†Ô∏è Service Worker failed to register';
                        statusBox.style.background = '#FFF3CD';
                    });
            } else {
                statusEl.textContent = '‚ùå Service Workers not supported';
                statusBox.style.background = '#FFEBEE';
            }
        }
        
        function updateNotificationUI() {
            var statusEl = document.getElementById('notifStatusText');
            var statusBox = document.getElementById('notificationStatus');
            var enableBtn = document.getElementById('enableNotifBtn');
            var testBtn = document.getElementById('testNotifBtn');
            var disableBtn = document.getElementById('disableNotifBtn');
            var freqDiv = document.getElementById('notifFrequency');
            
            var permission = Notification.permission;
            
            if (permission === 'granted') {
                statusEl.textContent = '‚úÖ Notifications are enabled!';
                statusBox.style.background = '#E8F5E9';
                enableBtn.style.display = 'none';
                testBtn.style.display = 'inline-block';
                disableBtn.style.display = 'inline-block';
                freqDiv.style.display = 'block';
                startPolling();
            } else if (permission === 'denied') {
                statusEl.textContent = 'üö´ Notifications blocked. Please enable in browser settings.';
                statusBox.style.background = '#FFEBEE';
                enableBtn.style.display = 'none';
                testBtn.style.display = 'none';
                disableBtn.style.display = 'none';
            } else {
                statusEl.textContent = 'üîî Enable notifications to get alerts when kids complete tasks';
                statusBox.style.background = '#E3F2FD';
                enableBtn.style.display = 'inline-block';
                testBtn.style.display = 'none';
                disableBtn.style.display = 'none';
            }
        }
        
        function enableNotifications() {
            Notification.requestPermission().then(function(permission) {
                updateNotificationUI();
                if (permission === 'granted') {
                    showToast('üîî Notifications enabled!', 'success');
                    // Store API URL for service worker
                    storeApiUrlForSW();
                }
            });
        }
        
        function disableNotifications() {
            stopPolling();
            showToast('üîï Notifications paused', 'success');
            document.getElementById('notifStatusText').textContent = '‚è∏Ô∏è Notifications paused (refresh to re-enable)';
            document.getElementById('notificationStatus').style.background = '#FFF3CD';
            document.getElementById('testNotifBtn').style.display = 'none';
            document.getElementById('disableNotifBtn').style.display = 'none';
        }
        
        function testNotification() {
            if (swRegistration) {
                swRegistration.showNotification('üåü Cub Stars Test', {
                    body: 'Notifications are working! You\'ll be notified when kids complete tasks.',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚≠ê</text></svg>',
                    tag: 'test-notification',
                    requireInteraction: false
                });
                showToast('üì≤ Test notification sent!', 'success');
            } else {
                // Fallback to regular notification
                new Notification('üåü Cub Stars Test', {
                    body: 'Notifications are working!'
                });
            }
        }
        
        function storeApiUrlForSW() {
            var request = indexedDB.open('cubstars-parent', 1);
            request.onupgradeneeded = function(e) {
                e.target.result.createObjectStore('settings');
            };
            request.onsuccess = function(e) {
                var db = e.target.result;
                var tx = db.transaction('settings', 'readwrite');
                var store = tx.objectStore('settings');
                store.put(API_URL, 'apiUrl');
            };
        }
        
        function startPolling() {
            if (notifPollInterval) clearInterval(notifPollInterval);
            var interval = parseInt(document.getElementById('pollInterval').value) || 60000;
            notifPollInterval = setInterval(checkForNewApprovals, interval);
            // Also check immediately
            setTimeout(checkForNewApprovals, 5000);
        }
        
        function stopPolling() {
            if (notifPollInterval) {
                clearInterval(notifPollInterval);
                notifPollInterval = null;
            }
        }
        
        function updatePollInterval() {
            startPolling();
            showToast('‚è±Ô∏è Update interval changed', 'success');
        }
        
        function checkForNewApprovals() {
            if (!data || !data.children) return;
            
            var pendingCount = 0;
            var pendingTasks = [];
            var pendingRewardClaims = [];
            
            data.children.forEach(function(child) {
                if (child.pendingApprovals && child.pendingApprovals.length > 0) {
                    child.pendingApprovals.forEach(function(approval) {
                        pendingCount++;
                        pendingTasks.push({ childName: child.name, taskName: approval.taskName });
                    });
                }
                if (child.pendingRewardClaims && child.pendingRewardClaims.length > 0) {
                    child.pendingRewardClaims.forEach(function(claim) {
                        pendingCount++;
                        pendingRewardClaims.push({ childName: child.name, rewardName: claim.rewardName });
                    });
                }
            });
            
            // Check for coupons too
            var coupons = JSON.parse(localStorage.getItem('cubstars_pending_coupons') || '[]');
            
            var totalPending = pendingCount + coupons.length;
            
            // Only notify if count increased
            if (totalPending > lastPendingCount && lastPendingCount >= 0) {
                var newItems = totalPending - lastPendingCount;
                
                if (document.hidden && Notification.permission === 'granted') {
                    var title = 'üìã ' + newItems + ' New Item' + (newItems > 1 ? 's' : '') + '!';
                    var body = '';
                    
                    if (pendingTasks.length > 0) {
                        body += pendingTasks.slice(0, 2).map(function(t) { return t.childName + ' completed ' + t.taskName; }).join('. ');
                    }
                    if (pendingRewardClaims.length > 0) {
                        if (body) body += '. ';
                        body += pendingRewardClaims.slice(0, 2).map(function(r) { return r.childName + ' wants ' + r.rewardName; }).join('. ');
                    }
                    if (coupons.length > 0 && coupons.length > (lastPendingCount - pendingCount)) {
                        if (body) body += '. ';
                        body += 'New coupon to redeem!';
                    }
                    
                    if (swRegistration) {
                        swRegistration.showNotification(title, {
                            body: body || 'Check the app for details',
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚úÖ</text></svg>',
                            tag: 'pending-approval-' + Date.now(),
                            requireInteraction: true,
                            actions: [{ action: 'open', title: 'üì± Review' }]
                        });
                    }
                }
            }
            
            lastPendingCount = totalPending;
        }
        
        // Update lastPendingCount when data loads
        var originalLoadData = loadData;
        loadData = function(force) {
            originalLoadData.call(this, force);
        };
        
        // Listen for visibility change to check on return
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadData(true);
            }
        });
    </script>
</body>
</html>
